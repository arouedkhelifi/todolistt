pipeline {
    agent any
    
    environment {
        PROJECT_NAME = "todolistt"
        BUILD_TIMESTAMP = bat(script: "@echo %date:~-4,4%%date:~-7,2%%date:~-10,2%_%time:~0,2%%time:~3,2%%time:~6,2%", returnStdout: true).trim()
        ARTIFACTS_DIR = "${WORKSPACE}\\artifacts"
        IMAGE_TAG = "${BUILD_NUMBER}-dev"
    }
    
    options {
        timeout(time: 2, unit: 'HOURS')
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }
    
    stages {
        stage('ðŸ” Checkout') {
            steps {
                script {
                    echo "======================================"
                    echo "ðŸ“Œ Stage 1: Checkout (DEV) - WINDOWS"
                    echo "======================================"
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: 'dev']],
                        userRemoteConfigs: [[url: 'https://github.com/arouedkhelifi/todolistt.git']]
                    ])
                    bat '''
                        @echo off
                        echo Branch: 
                        git rev-parse --abbrev-ref HEAD
                        echo.
                        echo Last 10 commits:
                        git log --oneline -10
                    '''
                    echo "âœ… Checkout Completed"
                }
            }
        }
        
        stage('âš™ï¸ Setup') {
            steps {
                script {
                    echo "======================================"
                    echo "âš™ï¸ Stage 2: Setup (DEV) - WINDOWS"
                    echo "======================================"
                    bat '''
                        @echo off
                        if not exist "%ARTIFACTS_DIR%" mkdir "%ARTIFACTS_DIR%"
                        
                        echo.
                        echo Verifying tools:
                        docker --version
                        docker-compose --version
                        
                        echo.
                        echo âœ… Setup Completed
                    '''
                }
            }
        }
        
        stage('ðŸ”¨ Build') {
            parallel {
                stage('Build Backend (Node 18)') {
                    steps {
                        script {
                            echo "ðŸ“¦ Building Backend (Node 18)..."
                            bat """
                                @echo off
                                set LOG_FILE=%ARTIFACTS_DIR%\\backend_build_node18_%BUILD_TIMESTAMP%.log
                                
                                echo Building backend image...
                                docker build -t %PROJECT_NAME%-backend:%IMAGE_TAG%-node18 -f Dockerfile.backend . > "%LOG_FILE%" 2>&1
                                
                                if errorlevel 1 (
                                    echo âŒ Backend Build FAILED
                                    type "%LOG_FILE%"
                                    exit /b 1
                                ) else (
                                    echo âœ… Backend Build PASSED
                                )
                            """
                        }
                    }
                }
                
                stage('Build Frontend (Node 18)') {
                    steps {
                        script {
                            echo "ðŸ“¦ Building Frontend (Node 18)..."
                            bat """
                                @echo off
                                set LOG_FILE=%ARTIFACTS_DIR%\\frontend_build_node18_%BUILD_TIMESTAMP%.log
                                
                                echo Building frontend image...
                                docker build -t %PROJECT_NAME%-frontend:%IMAGE_TAG%-node18 -f Dockerfile.frontend . > "%LOG_FILE%" 2>&1
                                
                                if errorlevel 1 (
                                    echo âŒ Frontend Build FAILED
                                    type "%LOG_FILE%"
                                    exit /b 1
                                ) else (
                                    echo âœ… Frontend Build PASSED
                                )
                            """
                        }
                    }
                }
            }
        }
        
        stage('ðŸš€ Run (Docker + Network)') {
            steps {
                script {
                    echo "======================================"
                    echo "ðŸš€ Stage 4: Run Docker Stack (DEV) - WINDOWS"
                    echo "======================================"
                    bat '''
                        @echo off
                        echo Stopping old containers...
                        docker-compose down -v 2>nul
                        
                        echo Creating Docker network...
                        docker network create %PROJECT_NAME%-network --driver bridge 2>nul || echo Network already exists
                        
                        echo Starting containers...
                        docker-compose up -d
                        
                        echo Waiting for services to start (20 seconds)...
                        timeout /t 20 /nobreak >nul
                        
                        echo Container status:
                        docker-compose ps > %ARTIFACTS_DIR%\\container_status_%BUILD_TIMESTAMP%.log
                        docker-compose ps
                        
                        echo âœ… Docker Stack Running
                    '''
                }
            }
        }
        
        stage('ðŸ§ª Smoke Test') {
            steps {
                script {
                    echo "======================================"
                    echo "ðŸ§ª Stage 5: Smoke Tests (DEV) - WINDOWS"
                    echo "======================================"
                    bat """
                        @echo off
                        set LOG_FILE=%ARTIFACTS_DIR%\\smoke_test_dev_%BUILD_TIMESTAMP%.log
                        set PASSED=0
                        set FAILED=0
                        
                        echo ====================================== > "%LOG_FILE%"
                        echo SMOKE TESTS REPORT >> "%LOG_FILE%"
                        echo ====================================== >> "%LOG_FILE%"
                        echo. >> "%LOG_FILE%"
                        
                        REM Test 1: Backend Health Check
                        echo.
                        echo [1/6] Testing Backend Health Check...
                        echo [1/6] Backend Health Check >> "%LOG_FILE%"
                        curl -s -o nul -w "%%{http_code}" http://localhost:5000 | findstr "200" >nul 2>&1
                        if errorlevel 1 (
                            curl -s -o nul -w "%%{http_code}" http://localhost:5000/health | findstr "200" >nul 2>&1
                            if errorlevel 1 (
                                echo âŒ FAILED: Backend not responding
                                echo âŒ FAILED >> "%LOG_FILE%"
                                set /a FAILED+=1
                            ) else (
                                echo âœ… PASSED: Backend is healthy
                                echo âœ… PASSED >> "%LOG_FILE%"
                                set /a PASSED+=1
                            )
                        ) else (
                            echo âœ… PASSED: Backend is healthy
                            echo âœ… PASSED >> "%LOG_FILE%"
                            set /a PASSED+=1
                        )
                        
                        REM Test 2: Frontend Health Check
                        echo.
                        echo [2/6] Testing Frontend Health Check...
                        echo [2/6] Frontend Health Check >> "%LOG_FILE%"
                        curl -s -o nul -w "%%{http_code}" http://localhost:3000 | findstr "200" >nul 2>&1
                        if errorlevel 1 (
                            echo âŒ FAILED: Frontend not responding
                            echo âŒ FAILED >> "%LOG_FILE%"
                            set /a FAILED+=1
                        ) else (
                            echo âœ… PASSED: Frontend is healthy
                            echo âœ… PASSED >> "%LOG_FILE%"
                            set /a PASSED+=1
                        )
                        
                        REM Test 3: MongoDB Connection
                        echo.
                        echo [3/6] Testing MongoDB Connection...
                        echo [3/6] MongoDB Connection >> "%LOG_FILE%"
                        docker exec todolistt-mongodb mongosh --eval "db.adminCommand('ping')" >nul 2>&1
                        if errorlevel 1 (
                            echo âŒ FAILED: MongoDB not accessible
                            echo âŒ FAILED >> "%LOG_FILE%"
                            set /a FAILED+=1
                        ) else (
                            echo âœ… PASSED: MongoDB is accessible
                            echo âœ… PASSED >> "%LOG_FILE%"
                            set /a PASSED+=1
                        )
                        
                        REM Test 4: Docker Network
                        echo.
                        echo [4/6] Testing Docker Network...
                        echo [4/6] Docker Network Connectivity >> "%LOG_FILE%"
                        docker network inspect %PROJECT_NAME%-network >nul 2>&1
                        if errorlevel 1 (
                            echo âŒ FAILED: Network not found
                            echo âŒ FAILED >> "%LOG_FILE%"
                            set /a FAILED+=1
                        ) else (
                            echo âœ… PASSED: Network exists and is healthy
                            echo âœ… PASSED >> "%LOG_FILE%"
                            set /a PASSED+=1
                        )
                        
                        REM Test 5: Container Status
                        echo.
                        echo [5/6] Testing Container Status...
                        echo [5/6] Container Status Check >> "%LOG_FILE%"
                        docker ps --filter "name=todolistt-backend" --format "{{.State}}" | findstr "running" >nul
                        if errorlevel 1 (
                            echo âŒ FAILED: Containers not running properly
                            echo âŒ FAILED >> "%LOG_FILE%"
                            set /a FAILED+=1
                        ) else (
                            echo âœ… PASSED: All containers are running
                            echo âœ… PASSED >> "%LOG_FILE%"
                            set /a PASSED+=1
                        )
                        
                        REM Test 6: Docker Images
                        echo.
                        echo [6/6] Testing Docker Images...
                        echo [6/6] Docker Images Verification >> "%LOG_FILE%"
                        docker images | findstr "%PROJECT_NAME%-backend" >nul
                        if errorlevel 1 (
                            echo âŒ FAILED: Docker images not found
                            echo âŒ FAILED >> "%LOG_FILE%"
                            set /a FAILED+=1
                        ) else (
                            echo âœ… PASSED: All images built successfully
                            echo âœ… PASSED >> "%LOG_FILE%"
                            set /a PASSED+=1
                        )
                        
                        REM Summary
                        echo. >> "%LOG_FILE%"
                        echo ====================================== >> "%LOG_FILE%"
                        echo SUMMARY >> "%LOG_FILE%"
                        echo ====================================== >> "%LOG_FILE%"
                        echo Tests Passed: %%PASSED%%/6 >> "%LOG_FILE%"
                        echo Tests Failed: %%FAILED%%/6 >> "%LOG_FILE%"
                        
                        echo.
                        echo ======================================
                        echo SMOKE TESTS SUMMARY
                        echo ======================================
                        echo Tests Passed: %%PASSED%%/6
                        echo Tests Failed: %%FAILED%%/6
                        
                        if %%FAILED%% GTR 0 (
                            echo.
                            echo âŒ Some tests failed!
                            type "%LOG_FILE%"
                            exit /b 1
                        ) else (
                            echo.
                            echo âœ… All Smoke Tests PASSED
                        )
                    """
                }
            }
        }
        
        stage('ðŸ“¦ Archive Artifacts') {
            steps {
                script {
                    echo "======================================"
                    echo "ðŸ“¦ Stage 6: Archive Artifacts (DEV) - WINDOWS"
                    echo "======================================"
                    bat """
                        @echo off
                        set REPORT_FILE=%ARTIFACTS_DIR%\\dev_pipeline_report_%BUILD_TIMESTAMP%.txt
                        
                        (
                            echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                            echo â•‘      DEV BUILD PIPELINE REPORT             â•‘
                            echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            echo.
                            echo BUILD INFORMATION
                            echo =================
                            echo Build Number: %BUILD_NUMBER%
                            echo Build Timestamp: %BUILD_TIMESTAMP%
                            echo Git Branch: dev
                            echo Build Status: âœ… SUCCESS
                            echo.
                            echo PIPELINE STAGES COMPLETED
                            echo =========================
                            echo âœ… Stage 1: Checkout - PASSED
                            echo âœ… Stage 2: Setup - PASSED
                            echo âœ… Stage 3: Build ^(Backend+Frontend Node18 parallel^) - PASSED
                            echo âœ… Stage 4: Run ^(Docker+Network^) - PASSED
                            echo âœ… Stage 5: Smoke Test ^(6/6 tests^) - PASSED
                            echo âœ… Stage 6: Archive Artifacts - PASSED
                            echo.
                            echo BUILD ARTIFACTS
                            echo ===============
                            echo - %PROJECT_NAME%-backend:%IMAGE_TAG%-node18
                            echo - %PROJECT_NAME%-frontend:%IMAGE_TAG%-node18
                            echo.
                            echo DATABASE
                            echo ========
                            echo - MongoDB 6 Alpine
                            echo - Credentials: admin/password123
                            echo - Database: todolistt
                            echo.
                            echo CONTAINERS RUNNING
                            echo ==================
                            echo - todolistt-mongodb ^(port 27017^)
                            echo - todolistt-backend ^(port 5000^)
                            echo - todolistt-frontend ^(port 3000^)
                            echo.
                            echo SMOKE TEST RESULTS ^(6/6 PASSED^)
                            echo ===============================
                            echo âœ… Test 1: Backend Health Check - PASSED
                            echo âœ… Test 2: Frontend Health Check - PASSED
                            echo âœ… Test 3: MongoDB Connection - PASSED
                            echo âœ… Test 4: Docker Network Connectivity - PASSED
                            echo âœ… Test 5: Container Status Check - PASSED
                            echo âœ… Test 6: Docker Images Verification - PASSED
                            echo.
                            echo NEXT: Ready for release tagging
                        ) > "%REPORT_FILE%"
                        
                        echo Capturing Docker logs...
                        docker-compose logs --no-color > %ARTIFACTS_DIR%\\docker_compose_logs_%BUILD_TIMESTAMP%.log 2>&1
                        
                        echo âœ… Artifacts Archived
                    """
                    
                    archiveArtifacts artifacts: 'artifacts/**', fingerprint: true, allowEmptyArchive: true
                }
            }
        }
        
        stage('ðŸ§¹ Cleanup') {
            steps {
                script {
                    echo "======================================"
                    echo "ðŸ§¹ Stage 7: Cleanup (DEV) - WINDOWS"
                    echo "======================================"
                    bat '''
                        @echo off
                        echo Stopping containers...
                        docker-compose down -v 2>nul
                        
                        echo Cleaning dangling images...
                        docker image prune -f --filter "dangling=true" 2>nul
                        
                        echo Cleaning unused volumes...
                        docker volume prune -f 2>nul
                        
                        echo Cleaning unused networks...
                        docker network prune -f 2>nul
                        
                        echo âœ… Cleanup Completed
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo ""
                echo "======================================"
                echo "ðŸ“Š PIPELINE EXECUTION SUMMARY"
                echo "======================================"
                echo "Build Number: ${BUILD_NUMBER}"
                echo "Duration: ${currentBuild.durationString}"
                echo "Workspace: ${WORKSPACE}"
                
                bat '''
                    @echo off
                    echo.
                    echo Current Docker Status:
                    echo =====================
                    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                '''
            }
        }
        
        success {
            script {
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘  âœ… DEV PIPELINE PASSED - Ready for releaseâ•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ðŸŽ‰ All stages passed!"
                echo "ðŸŒ Frontend: http://localhost:3000"
                echo "ðŸ”§ Backend:  http://localhost:5000"
                echo "ðŸ“¦ Artifacts: Check the build artifacts"
            }
        }
        
        failure {
            script {
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘  âŒ DEV PIPELINE FAILED                    â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "Check the console output for details"
                
                bat '''
                    @echo off
                    echo.
                    echo Debugging Information:
                    echo =====================
                    echo.
                    echo Docker Containers:
                    docker ps -a
                    echo.
                    echo Docker Images:
                    docker images | findstr "%PROJECT_NAME%"
                    echo.
                    echo Last Docker Compose logs:
                    docker-compose logs --tail=20 2>nul
                '''
            }
        }
    }
}
