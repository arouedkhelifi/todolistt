pipeline {
    agent any
    
    environment {
        PROJECT_NAME = "todolistt"
        BUILD_TIMESTAMP = sh(script: "date +%Y%m%d_%H%M%S", returnStdout: true).trim()
        ARTIFACTS_DIR = "${WORKSPACE}/artifacts"
        IMAGE_TAG = "${BUILD_NUMBER}-pr"
    }
    
    stages {
        stage('üîç Checkout') {
            steps {
                script {
                    echo "======================================"
                    echo "üìå Stage 1: Checkout (PR)"
                    echo "======================================"
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "${CHANGE_BRANCH}"]],
                        userRemoteConfigs: [[url: 'https://github.com/arouedkhelifi/todolistt.git']]
                    ])
                    sh '''
                        echo "Current Branch: $(git rev-parse --abbrev-ref HEAD)"
                        echo "Current Commit: $(git rev-parse HEAD)"
                        git log --oneline -5
                    '''
                    echo "‚úÖ Checkout Completed"
                }
            }
        }
        
        stage('‚öôÔ∏è Setup') {
            steps {
                script {
                    echo "======================================"
                    echo "‚öôÔ∏è Stage 2: Setup (PR)"
                    echo "======================================"
                    sh '''
                        mkdir -p ${ARTIFACTS_DIR}
                        docker --version
                        docker-compose --version
                        echo "‚úÖ Setup Completed"
                    '''
                }
            }
        }
        
        stage('üî® Build') {
            parallel {
                stage('Build Backend') {
                    steps {
                        script {
                            echo "üì¶ Building Backend..."
                            sh '''
                                docker build -t ${PROJECT_NAME}-backend:${IMAGE_TAG} -f Dockerfile.backend .  2>&1 | tee ${ARTIFACTS_DIR}/backend_build_${BUILD_TIMESTAMP}.log
                                if [ ${PIPESTATUS[0]} -eq 0 ]; then
                                    echo "‚úÖ Backend Build PASSED"
                                else
                                    echo "‚ùå Backend Build FAILED"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
                
                stage('Build Frontend') {
                    steps {
                        script {
                            echo "üì¶ Building Frontend..."
                            sh '''
                                docker build -t ${PROJECT_NAME}-frontend:${IMAGE_TAG} -f Dockerfile.frontend .  2>&1 | tee ${ARTIFACTS_DIR}/frontend_build_${BUILD_TIMESTAMP}. log
                                if [ ${PIPESTATUS[0]} -eq 0 ]; then
                                    echo "‚úÖ Frontend Build PASSED"
                                else
                                    echo "‚ùå Frontend Build FAILED"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('üöÄ Run (Docker)') {
            steps {
                script {
                    echo "======================================"
                    echo "üöÄ Stage 4: Run Docker Containers"
                    echo "======================================"
                    sh '''
                        docker-compose down -v 2>/dev/null || true
                        docker network create ${PROJECT_NAME}-network --driver bridge 2>/dev/null || true
                        docker-compose up -d
                        sleep 15
                        docker-compose ps
                        echo "‚úÖ Docker Containers Running"
                    '''
                }
            }
        }
        
        stage('üß™ Smoke Test') {
            steps {
                script {
                    echo "======================================"
                    echo "üß™ Stage 5: Smoke Tests"
                    echo "======================================"
                    sh '''
                        bash scripts/smoke-tests.sh 2>&1 | tee ${ARTIFACTS_DIR}/smoke_test_pr_${BUILD_TIMESTAMP}.log
                        if [ ${PIPESTATUS[0]} -eq 0 ]; then
                            echo "‚úÖ All Smoke Tests PASSED"
                        else
                            echo "‚ùå Smoke Tests FAILED"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('üì¶ Archive Artifacts') {
            steps {
                script {
                    echo "======================================"
                    echo "üì¶ Stage 6: Archive Artifacts"
                    echo "======================================"
                    sh '''
                        cat > ${ARTIFACTS_DIR}/pr_pipeline_report_${BUILD_TIMESTAMP}.txt << 'REPORT'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      PR BUILD PIPELINE REPORT              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

BUILD INFORMATION
=================
Build Number: ${BUILD_NUMBER}
Build Timestamp: ${BUILD_TIMESTAMP}
Git Branch: ${CHANGE_BRANCH}
Build Status: ‚úÖ SUCCESS

PIPELINE STAGES COMPLETED
=========================
‚úÖ Stage 1: Checkout - PASSED
‚úÖ Stage 2: Setup - PASSED
‚úÖ Stage 3: Build (Backend + Frontend parallel) - PASSED
‚úÖ Stage 4: Run (Docker + Network) - PASSED
‚úÖ Stage 5: Smoke Test (6/6 tests) - PASSED
‚úÖ Stage 6: Archive Artifacts - PASSED

DOCKER IMAGES
=============
- ${PROJECT_NAME}-backend:${IMAGE_TAG}
- ${PROJECT_NAME}-frontend:${IMAGE_TAG}

SMOKE TEST RESULTS (6/6 PASSED)
===============================
‚úÖ Test 1: Backend Health Check - PASSED
‚úÖ Test 2: Frontend Health Check - PASSED
‚úÖ Test 3: MongoDB Connection - PASSED
‚úÖ Test 4: Docker Network Connectivity - PASSED
‚úÖ Test 5: Container Status Check - PASSED
‚úÖ Test 6: Docker Images Verification - PASSED

FINAL VERDICT: ‚úÖ PR APPROVED FOR REVIEW
REPORT

                        docker-compose logs > ${ARTIFACTS_DIR}/docker_compose_logs_${BUILD_TIMESTAMP}.  log 2>&1 || true
                        
                        echo "‚úÖ Artifacts Archived"
                    '''
                    
                    archiveArtifacts artifacts: 'artifacts/**', fingerprint: true, allowEmptyArchive: true
                }
            }
        }
        
        stage('üßπ Cleanup') {
            steps {
                script {
                    echo "======================================"
                    echo "üßπ Stage 7: Cleanup"
                    echo "======================================"
                    sh '''
                        bash scripts/cleanup.sh
                        echo "‚úÖ Cleanup Completed"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo ""
            echo "======================================"
            echo "PR Pipeline Finished"
            echo "======================================"
        }
        success {
            echo "‚úÖ PR PIPELINE PASSED"
        }
        failure {
            echo "‚ùå PR PIPELINE FAILED"
        }
    }
}
