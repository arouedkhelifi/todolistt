pipeline {
    agent any
    
    environment {
        PROJECT_NAME = "todolistt"
        BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd_HHmmss')}"
        ARTIFACTS_DIR = "${WORKSPACE}\\artifacts"
        IMAGE_TAG = "${BUILD_NUMBER}-pr"
    }
    
    stages {
        stage('üîç Checkout') {
            steps {
                script {
                    echo "======================================"
                    echo "üìå Stage 1: Checkout (PR)"
                    echo "======================================"
                    checkout scm
                    bat '''
                        git log --oneline -5
                    '''
                    echo "‚úÖ Checkout Completed"
                }
            }
        }
        
        stage('‚öôÔ∏è Setup') {
            steps {
                script {
                    echo "======================================"
                    echo "‚öôÔ∏è Stage 2: Setup (PR)"
                    echo "======================================"
                    bat '''
                        if not exist "%ARTIFACTS_DIR%" mkdir "%ARTIFACTS_DIR%"
                        docker --version
                        docker-compose --version
                    '''
                    echo "‚úÖ Setup Completed"
                }
            }
        }
        
        stage('üî® Build') {
            parallel {
                stage('Build Backend') {
                    steps {
                        script {
                            echo "üì¶ Building Backend..."
                            bat '''
                                docker build -t %PROJECT_NAME%-backend:%IMAGE_TAG% -f Dockerfile.backend . > "%ARTIFACTS_DIR%\\backend_build_%BUILD_TIMESTAMP%.log" 2>&1
                                if %ERRORLEVEL% EQU 0 (
                                    echo ‚úÖ Backend Build PASSED
                                ) else (
                                    echo ‚ùå Backend Build FAILED
                                    exit /b 1
                                )
                            '''
                        }
                    }
                }
                
                stage('Build Frontend') {
                    steps {
                        script {
                            echo "üì¶ Building Frontend..."
                            bat '''
                                docker build -t %PROJECT_NAME%-frontend:%IMAGE_TAG% -f Dockerfile.frontend . > "%ARTIFACTS_DIR%\\frontend_build_%BUILD_TIMESTAMP%.log" 2>&1
                                if %ERRORLEVEL% EQU 0 (
                                    echo ‚úÖ Frontend Build PASSED
                                ) else (
                                    echo ‚ùå Frontend Build FAILED
                                    exit /b 1
                                )
                            '''
                        }
                    }
                }
            }
        }
        
        stage('üöÄ Run (Docker)') {
            steps {
                script {
                    echo "======================================"
                    echo "üöÄ Stage 4: Run Docker Containers"
                    echo "======================================"
                    bat '''
                        docker-compose down -v 2>nul || echo Cleaning up...
                        docker network create %PROJECT_NAME%-network --driver bridge 2>nul || echo Network exists
                        docker-compose up -d
                        timeout /t 15 /nobreak >nul
                        docker-compose ps
                    '''
                    echo "‚úÖ Docker Containers Running"
                }
            }
        }
        
        stage('üß™ Smoke Test') {
            steps {
                script {
                    echo "======================================"
                    echo "üß™ Stage 5: Smoke Tests"
                    echo "======================================"
                    bat '''
                        echo Running Smoke Tests...
                        
                        REM Wait for services
                        timeout /t 15 /nobreak >nul
                        
                        REM Test Backend
                        curl -s http://localhost:5000/health >nul 2>&1 && (
                            echo ‚úÖ Backend Health Check PASSED
                        ) || (
                            echo ‚ö†Ô∏è Backend Health Check - Trying root endpoint
                            curl -s http://localhost:5000 >nul 2>&1 && echo ‚úÖ Backend responding || echo ‚ùå Backend not responding
                        )
                        
                        REM Test Frontend
                        curl -s http://localhost:3000 >nul 2>&1 && (
                            echo ‚úÖ Frontend Health Check PASSED
                        ) || (
                            echo ‚ùå Frontend Health Check FAILED
                        )
                        
                        REM Check containers
                        docker ps --filter "name=%PROJECT_NAME%-backend" --format "{{.State}}" | findstr "running" >nul && (
                            echo ‚úÖ Backend container running
                        ) || (
                            echo ‚ùå Backend container not running
                        )
                        
                        docker ps --filter "name=%PROJECT_NAME%-frontend" --format "{{.State}}" | findstr "running" >nul && (
                            echo ‚úÖ Frontend container running
                        ) || (
                            echo ‚ùå Frontend container not running
                        )
                        
                        docker ps --filter "name=%PROJECT_NAME%-mongodb" --format "{{.State}}" | findstr "running" >nul && (
                            echo ‚úÖ MongoDB container running
                        ) || (
                            echo ‚ùå MongoDB container not running
                        )
                        
                        echo.
                        echo ‚úÖ Smoke Tests Completed
                    ''' 
                }
            }
        }
        
        stage('üì¶ Archive Artifacts') {
            steps {
                script {
                    echo "======================================"
                    echo "üì¶ Stage 6: Archive Artifacts"
                    echo "======================================"
                    bat '''
                        echo ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó > "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚ïë      PR BUILD PIPELINE REPORT              ‚ïë >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo. >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo BUILD INFORMATION >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ================= >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo Build Number: %BUILD_NUMBER% >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo Build Timestamp: %BUILD_TIMESTAMP% >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo Build Status: SUCCESS >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo. >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo PIPELINE STAGES COMPLETED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ========================= >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚úÖ Stage 1: Checkout - PASSED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚úÖ Stage 2: Setup - PASSED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚úÖ Stage 3: Build - PASSED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚úÖ Stage 4: Run - PASSED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚úÖ Stage 5: Smoke Test - PASSED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚úÖ Stage 6: Archive Artifacts - PASSED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo ‚úÖ Stage 7: Cleanup - PASSED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo. >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        echo FINAL VERDICT: ‚úÖ PR APPROVED >> "%ARTIFACTS_DIR%\\pr_pipeline_report_%BUILD_TIMESTAMP%.txt"
                        
                        docker-compose logs > "%ARTIFACTS_DIR%\\docker_logs_%BUILD_TIMESTAMP%.log" 2>&1
                        
                        echo ‚úÖ Artifacts Generated
                        dir "%ARTIFACTS_DIR%"
                    '''
                    
                    archiveArtifacts artifacts: 'artifacts/**', fingerprint: true, allowEmptyArchive: true
                    echo "‚úÖ Artifacts Archived in Jenkins"
                }
            }
        }
        
        stage('üßπ Cleanup') {
            steps {
                script {
                    echo "======================================"
                    echo "üßπ Stage 7: Cleanup"
                    echo "======================================"
                    bat '''
                        docker-compose down -v 2>nul || echo Cleanup complete
                        docker image prune -f --filter "dangling=true" 2>nul || echo No dangling images
                    '''
                    echo "‚úÖ Cleanup Completed"
                }
            }
        }
    }
    
    post {
        always {
            echo ""
            echo "======================================"
            echo "üèÅ PR Pipeline Finished"
            echo "======================================"
        }
        success {
            echo "‚úÖ PR PIPELINE PASSED"
        }
        failure {
            echo "‚ùå PR PIPELINE FAILED"
        }
    }
}