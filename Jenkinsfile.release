pipeline {
    agent any
    
    environment {
        PROJECT_NAME = "todolistt"
        VERSION = sh(script: "git describe --tags --abbrev=0 2>/dev/null || echo 'v1.0.0'", returnStdout: true).trim()
        BUILD_TIMESTAMP = sh(script: "date +%Y%m%d_%H%M%S", returnStdout: true).trim()
        ARTIFACTS_DIR = "${WORKSPACE}/artifacts"
        IMAGE_TAG = "${VERSION}-${BUILD_NUMBER}"
    }
    
    stages {
        stage('üîç Checkout') {
            steps {
                script {
                    echo "======================================"
                    echo "üìå Stage 1: Checkout (RELEASE)"
                    echo "======================================"
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: 'main']],
                        userRemoteConfigs: [[url: 'https://github.com/arouedkhelifi/todolistt.git']]
                    ])
                    sh '''
                        echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
                        git tag -l -n1
                    '''
                    echo "‚úÖ Checkout Completed"
                }
            }
        }
        
        stage('‚öôÔ∏è Setup') {
            steps {
                script {
                    echo "======================================"
                    echo "‚öôÔ∏è Stage 2: Setup (RELEASE)"
                    echo "======================================"
                    sh '''
                        mkdir -p ${ARTIFACTS_DIR}
                        docker --version
                        docker-compose --version
                        echo "Release Configuration:"
                        echo "Version: ${VERSION}"
                        echo "‚úÖ Setup Completed"
                    '''
                }
            }
        }
        
        stage('üî® Build') {
            parallel {
                stage('Build Backend - Release') {
                    steps {
                        script {
                            echo "üì¶ Building Backend Release Image..."
                            sh '''
                                docker build \
                                    -t ${PROJECT_NAME}-backend:${VERSION} \
                                    -t ${PROJECT_NAME}-backend:${IMAGE_TAG} \
                                    -t ${PROJECT_NAME}-backend:latest \
                                    -f Dockerfile.backend .   2>&1 | tee ${ARTIFACTS_DIR}/backend_build_release_${BUILD_TIMESTAMP}.log
                                
                                if [ ${PIPESTATUS[0]} -eq 0 ]; then
                                    echo "‚úÖ Backend Build PASSED"
                                else
                                    echo "‚ùå Backend Build FAILED"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
                
                stage('Build Frontend - Release') {
                    steps {
                        script {
                            echo "üì¶ Building Frontend Release Image..."
                            sh '''
                                docker build \
                                    -t ${PROJECT_NAME}-frontend:${VERSION} \
                                    -t ${PROJECT_NAME}-frontend:${IMAGE_TAG} \
                                    -t ${PROJECT_NAME}-frontend:latest \
                                    -f Dockerfile.frontend .  2>&1 | tee ${ARTIFACTS_DIR}/frontend_build_release_${BUILD_TIMESTAMP}.log
                                
                                if [ ${PIPESTATUS[0]} -eq 0 ]; then
                                    echo "‚úÖ Frontend Build PASSED"
                                else
                                    echo "‚ùå Frontend Build FAILED"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('üöÄ Run (Docker + Network)') {
            steps {
                script {
                    echo "======================================"
                    echo "üöÄ Stage 4: Run Docker Stack (RELEASE)"
                    echo "======================================"
                    sh '''
                        docker-compose down -v 2>/dev/null || true
                        docker network create ${PROJECT_NAME}-network --driver bridge 2>/dev/null || true
                        docker-compose up -d
                        sleep 20
                        docker-compose ps | tee ${ARTIFACTS_DIR}/container_status_${BUILD_TIMESTAMP}.txt
                        echo "‚úÖ Docker Stack Running"
                    '''
                }
            }
        }
        
        stage('üß™ Smoke Test') {
            steps {
                script {
                    echo "======================================"
                    echo "üß™ Stage 5: Smoke Tests (RELEASE)"
                    echo "======================================"
                    sh '''
                        bash scripts/smoke-tests.sh 2>&1 | tee ${ARTIFACTS_DIR}/smoke_test_release_${BUILD_TIMESTAMP}.log
                        if [ ${PIPESTATUS[0]} -eq 0 ]; then
                            echo "‚úÖ All Release Smoke Tests PASSED"
                        else
                            echo "‚ùå Release Smoke Tests FAILED"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('üì¶ Archive Artifacts') {
            steps {
                script {
                    echo "======================================"
                    echo "üì¶ Stage 6: Archive Artifacts (RELEASE)"
                    echo "======================================"
                    sh '''
                        cat > ${ARTIFACTS_DIR}/release_report_${VERSION}_${BUILD_TIMESTAMP}.txt << 'REPORT'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   TODOLISTT RELEASE BUILD REPORT v${VERSION}    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

BUILD INFORMATION
=================
Version: ${VERSION}
Build Number: ${BUILD_NUMBER}
Build Timestamp: ${BUILD_TIMESTAMP}
Build Status: ‚úÖ SUCCESS

PIPELINE STAGES COMPLETED
=========================
‚úÖ Stage 1: Checkout - PASSED
‚úÖ Stage 2: Setup - PASSED
‚úÖ Stage 3: Build (Backend+Frontend parallel) - PASSED
‚úÖ Stage 4: Run (Docker+Network) - PASSED
‚úÖ Stage 5: Smoke Test (6/6 tests) - PASSED
‚úÖ Stage 6: Archive Artifacts - PASSED

DOCKER IMAGES - PRODUCTION
==========================
Backend:
  - ${PROJECT_NAME}-backend:${VERSION}
  - ${PROJECT_NAME}-backend:${IMAGE_TAG}
  - ${PROJECT_NAME}-backend:latest

Frontend:
  - ${PROJECT_NAME}-frontend:${VERSION}
  - ${PROJECT_NAME}-frontend:${IMAGE_TAG}
  - ${PROJECT_NAME}-frontend:latest

DATABASE - PRODUCTION
=====================
- MongoDB 6 Alpine
- Credentials: admin/password123
- Database: todolistt
- Data Persistence: ‚úÖ Enabled

DEPLOYMENT - PRODUCTION
=======================
Network: todolistt-network (bridge)
Backend Service: todolistt-backend (port 5000)
Frontend Service: todolistt-frontend (port 3000)
MongoDB Service: todolistt-mongodb (port 27017)

SMOKE TEST RESULTS (6/6 PASSED)
===============================
‚úÖ Test 1: Backend Health Check - PASSED
‚úÖ Test 2: Frontend Health Check - PASSED
‚úÖ Test 3: MongoDB Connection - PASSED
‚úÖ Test 4: Docker Network Connectivity - PASSED
‚úÖ Test 5: Container Status Check - PASSED
‚úÖ Test 6: Docker Images Verification - PASSED

FINAL VERDICT: ‚úÖ PRODUCTION READY
REPORT

                        docker-compose logs --no-color > ${ARTIFACTS_DIR}/docker_compose_release_logs_${BUILD_TIMESTAMP}.log 2>&1 || true
                        
                        echo "‚úÖ Artifacts Archived"
                    '''
                    
                    archiveArtifacts artifacts: 'artifacts/**', fingerprint: true, allowEmptyArchive: true
                }
            }
        }
        
        stage('üßπ Cleanup') {
            steps {
                script {
                    echo "======================================"
                    echo "üßπ Stage 7: Cleanup (RELEASE)"
                    echo "======================================"
                    sh '''
                        bash scripts/cleanup.sh
                        echo "‚úÖ Cleanup Completed"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo ""
            echo "======================================"
            echo "Release Pipeline Finished"
            echo "======================================"
        }
        success {
            echo "‚úÖ RELEASE BUILD ${VERSION} PASSED - Production Ready!"
        }
        failure {
            echo "‚ùå RELEASE BUILD ${VERSION} FAILED"
        }
    }
}
