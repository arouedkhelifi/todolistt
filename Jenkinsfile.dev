pipeline {
    agent any
    
    environment {
        PROJECT_NAME = "todolistt"
        BUILD_TIMESTAMP = sh(script: "date +%Y%m%d_%H%M%S", returnStdout: true).trim()
        ARTIFACTS_DIR = "${WORKSPACE}/artifacts"
        IMAGE_TAG = "${BUILD_NUMBER}-dev"
    }
    
    stages {
        stage('üîç Checkout') {
            steps {
                script {
                    echo "======================================"
                    echo "üìå Stage 1: Checkout (DEV)"
                    echo "======================================"
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: 'dev']],
                        userRemoteConfigs: [[url: 'https://github.com/arouedkhelifi/todolistt.git']]
                    ])
                    sh '''
                        echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
                        git log --oneline -10
                    '''
                    echo "‚úÖ Checkout Completed"
                }
            }
        }
        
        stage('‚öôÔ∏è Setup') {
            steps {
                script {
                    echo "======================================"
                    echo "‚öôÔ∏è Stage 2: Setup (DEV)"
                    echo "======================================"
                    sh '''
                        mkdir -p ${ARTIFACTS_DIR}
                        docker --version
                        docker-compose --version
                        echo "‚úÖ Setup Completed"
                    '''
                }
            }
        }
        
        stage('üî® Build') {
            parallel {
                stage('Build Backend (Node 18)') {
                    steps {
                        script {
                            echo "üì¶ Building Backend (Node 18)..."
                            sh '''
                                docker build -t ${PROJECT_NAME}-backend:${IMAGE_TAG}-node18 -f Dockerfile. backend .  2>&1 | tee ${ARTIFACTS_DIR}/backend_build_node18_${BUILD_TIMESTAMP}. log
                                if [ ${PIPESTATUS[0]} -eq 0 ]; then
                                    echo "‚úÖ Backend Build PASSED"
                                else
                                    echo "‚ùå Backend Build FAILED"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
                
                stage('Build Frontend (Node 18)') {
                    steps {
                        script {
                            echo "üì¶ Building Frontend (Node 18)..."
                            sh '''
                                docker build -t ${PROJECT_NAME}-frontend:${IMAGE_TAG}-node18 -f Dockerfile.frontend . 2>&1 | tee ${ARTIFACTS_DIR}/frontend_build_node18_${BUILD_TIMESTAMP}.log
                                if [ ${PIPESTATUS[0]} -eq 0 ]; then
                                    echo "‚úÖ Frontend Build PASSED"
                                else
                                    echo "‚ùå Frontend Build FAILED"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('üöÄ Run (Docker + Network)') {
            steps {
                script {
                    echo "======================================"
                    echo "üöÄ Stage 4: Run Docker Stack (DEV)"
                    echo "======================================"
                    sh '''
                        docker-compose down -v 2>/dev/null || true
                        docker network create ${PROJECT_NAME}-network --driver bridge 2>/dev/null || true
                        docker-compose up -d
                        sleep 20
                        docker-compose ps | tee ${ARTIFACTS_DIR}/container_status_${BUILD_TIMESTAMP}.log
                        echo "‚úÖ Docker Stack Running"
                    '''
                }
            }
        }
        
        stage('üß™ Smoke Test') {
            steps {
                script {
                    echo "======================================"
                    echo "üß™ Stage 5: Smoke Tests (DEV)"
                    echo "======================================"
                    sh '''
                        bash scripts/smoke-tests.sh 2>&1 | tee ${ARTIFACTS_DIR}/smoke_test_dev_${BUILD_TIMESTAMP}.log
                        if [ ${PIPESTATUS[0]} -eq 0 ]; then
                            echo "‚úÖ All Smoke Tests PASSED"
                        else
                            echo "‚ùå Smoke Tests FAILED"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('üì¶ Archive Artifacts') {
            steps {
                script {
                    echo "======================================"
                    echo "üì¶ Stage 6: Archive Artifacts (DEV)"
                    echo "======================================"
                    sh '''
                        cat > ${ARTIFACTS_DIR}/dev_pipeline_report_${BUILD_TIMESTAMP}. txt << 'REPORT'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      DEV BUILD PIPELINE REPORT             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

BUILD INFORMATION
=================
Build Number: ${BUILD_NUMBER}
Build Timestamp: ${BUILD_TIMESTAMP}
Git Branch: dev
Build Status: ‚úÖ SUCCESS

PIPELINE STAGES COMPLETED
=========================
‚úÖ Stage 1: Checkout - PASSED
‚úÖ Stage 2: Setup - PASSED
‚úÖ Stage 3: Build (Backend+Frontend Node18 parallel) - PASSED
‚úÖ Stage 4: Run (Docker+Network) - PASSED
‚úÖ Stage 5: Smoke Test (6/6 tests) - PASSED
‚úÖ Stage 6: Archive Artifacts - PASSED

BUILD ARTIFACTS
===============
- ${PROJECT_NAME}-backend:${IMAGE_TAG}-node18
- ${PROJECT_NAME}-frontend:${IMAGE_TAG}-node18

DATABASE
========
- MongoDB 6 Alpine
- Credentials: admin/password123
- Database: todolistt

CONTAINERS RUNNING
==================
- todolistt-mongodb (port 27017)
- todolistt-backend (port 5000)
- todolistt-frontend (port 3000)

SMOKE TEST RESULTS (6/6 PASSED)
===============================
‚úÖ Test 1: Backend Health Check - PASSED
‚úÖ Test 2: Frontend Health Check - PASSED
‚úÖ Test 3: MongoDB Connection - PASSED
‚úÖ Test 4: Docker Network Connectivity - PASSED
‚úÖ Test 5: Container Status Check - PASSED
‚úÖ Test 6: Docker Images Verification - PASSED

NEXT: Ready for release tagging
REPORT

                        docker-compose logs --no-color > ${ARTIFACTS_DIR}/docker_compose_logs_${BUILD_TIMESTAMP}.log 2>&1 || true
                        
                        echo "‚úÖ Artifacts Archived"
                    '''
                    
                    archiveArtifacts artifacts: 'artifacts/**', fingerprint: true, allowEmptyArchive: true
                }
            }
        }
        
        stage('üßπ Cleanup') {
            steps {
                script {
                    echo "======================================"
                    echo "üßπ Stage 7: Cleanup (DEV)"
                    echo "======================================"
                    sh '''
                        bash scripts/cleanup.sh
                        echo "‚úÖ Cleanup Completed"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo ""
            echo "======================================"
            echo "DEV Pipeline Finished"
            echo "======================================"
        }
        success {
            echo "‚úÖ DEV PIPELINE PASSED - Ready for release"
        }
        failure {
            echo "‚ùå DEV PIPELINE FAILED"
        }
    }
}
